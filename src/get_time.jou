# TODO(Jou): this whole file content belongs to stdlib/time.jou

import "stdlib/assert.jou"
import "stdlib/process.jou"
import "stdlib/time.jou"
import "stdlib/str.jou"

class tm:
    tm_sec: int
    tm_min: int
    tm_hour: int
    tm_mday: int
    tm_mon: int
    tm_year: int
    tm_wday: int
    tm_yday: int
    tm_isdst: int

    # There may be additional fields (e.g. tm_gmtoff, tm_zone), ignore them
    _padding: byte[100]


declare localtime(timer: int64*) -> tm*

@public
def get_minute_of_day() -> int:
    env_time = getenv("HIMMELI_TESTS_TIME")
    if env_time == NULL:
        # The usual case.
        now = time(NULL)
        t = localtime(&now)
        assert t != NULL
        return 60*t.tm_hour + t.tm_min
    else:
        # This is what happens during tests.
        hh, mm: int
        ret = sscanf(env_time, "%d:%d", &hh, &mm)
        assert ret == 2
        return 60*hh + mm
